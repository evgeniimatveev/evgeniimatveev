name: README Ticker (every 20m)

on:
  # Runs every 20 minutes; change to */15 or */30 if you prefer
  schedule:
    - cron: "*/20 * * * *"
  # Allows manual runs from the GitHub UI
  workflow_dispatch: {}

permissions:
  contents: write

# Prevent overlapping runs of this workflow
concurrency:
  group: readme-ticker
  cancel-in-progress: true

jobs:
  tick:
    runs-on: ubuntu-latest

    # Keep these in sync with your daily job (controls the gray text timer fallback)
    env:
      NEXT_UPDATE_HOUR: "12"
      NEXT_UPDATE_MIN:  "15"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Compute timers and totals
        shell: bash
        run: |
          python - <<'PY'
          import os, json, datetime, pathlib
          env = os.environ['GITHUB_ENV']

          # 1) Try to read dynamic "Next Update" message from the badge JSON
          msg = ''
          try:
              d = json.loads(pathlib.Path('badges/next_update.json').read_text('utf-8'))
              msg = d.get('message','')
          except Exception:
              pass

          # 2) Fallback: compute human-readable time until the next daily window
          if not msg:
              h = int(os.getenv('NEXT_UPDATE_HOUR','12'))
              m = int(os.getenv('NEXT_UPDATE_MIN', '15'))
              now = datetime.datetime.utcnow()
              eta = now.replace(hour=h, minute=m, second=0, microsecond=0)
              if now >= eta:
                  eta += datetime.timedelta(days=1)
              left = eta - now
              T = int(left.total_seconds())
              H = T // 3600
              M = (T % 3600) // 60
              msg = (f"in {M}m" if H == 0 else f"in {H}h {M:02d}m")

          # 3) Total updates (written by the daily job); show '?' if not available yet
          tot = '?'
          try:
              tot = pathlib.Path('.ci/update_count.txt').read_text('utf-8').strip() or '?'
          except Exception:
              pass

          with open(env, 'a') as f:
              f.write(f"NEXT_UPDATE_TEXT={msg}\n")
              f.write(f"TOTAL_UPDATES={tot}\n")
          PY

      - name: Refresh STATUS (top) and STATUS2 (bottom)
        shell: bash
        run: |
          set -e
          NEXT_ENDPOINT="https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/${GITHUB_REF_NAME}/badges/next_update.json"

          # --- Top panel (centered) ---
          TOP="<p align=\"center\">
          <img src=\"https://img.shields.io/endpoint?url=${NEXT_ENDPOINT}&cacheSeconds=120&t=${GITHUB_RUN_NUMBER}\" />
          <img src=\"https://img.shields.io/static/v1?label=Next%20Update&message=${NEXT_UPDATE_TEXT// /%20}&color=757575&labelColor=30363d&cacheSeconds=600\" />
          <img src=\"https://img.shields.io/static/v1?label=Updates&message=${TOTAL_UPDATES:-?}&color=0ea5e9&cacheSeconds=300\" />
          </p>"

          awk -v r="$TOP" '
            /<!-- STATUS:START -->/ {print; print r; f=1; next}
            /<!-- STATUS:END -->/   {f=0}
            !f
          ' README.md > README.tmp && mv README.tmp README.md

          # --- Bottom panel (left-aligned) ---
          LOW="<p align=\"left\">
          <img src=\"https://img.shields.io/endpoint?url=${NEXT_ENDPOINT}&cacheSeconds=120&t=${GITHUB_RUN_NUMBER}\" />
          <img src=\"https://img.shields.io/static/v1?label=Next%20Update&message=${NEXT_UPDATE_TEXT// /%20}&color=757575&labelColor=30363d&cacheSeconds=600\" />
          <img src=\"https://img.shields.io/static/v1?label=Updates&message=${TOTAL_UPDATES:-?}&color=0ea5e9&labelColor=30363d&cacheSeconds=300\" />
          </p>"

          awk -v r="$LOW" '
            /<!-- STATUS2:START -->/ {print; print r; f=1; next}
            /<!-- STATUS2:END -->/   {f=0}
            !f
          ' README.md > README.tmp && mv README.tmp README.md

      - name: Commit if changed
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git add README.md || true
          if git diff --cached --quiet; then
            echo "No visible ticker changes."
            exit 0
          fi
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "README ticker: refresh timers and counters"
          git push
