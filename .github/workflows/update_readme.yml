name: Auto Update README v7.7.0

on:
  schedule:
    - cron: "15 12 * * *" # 12:15 UTC daily
  workflow_dispatch:
    inputs:
      banner_mode:
        description: "sequential | random | calendar"
        type: choice
        options: [sequential, random, calendar]
        default: sequential
      insight:
        description: "Override MLOPS_INSIGHT"
        type: string
        default: ""
      emojis:
        description: "Comma-separated emoji list"
        type: string
        default: ""
      jsonl_keep_lines:
        description: "Keep last N lines in update_log.jsonl"
        type: number
        default: 200
      txt_keep_lines:
        description: "Keep last N lines in update_log.txt"
        type: number
        default: 70
      table_n:
        description: "Show last N rows in README table"
        type: number
        default: 5
      commit_mode:
        description: "auto | dry-run | force"
        type: choice
        options: [auto, dry-run, force]
        default: auto
      next_update_hour:
        description: "UTC hour for Next Update text fallback"
        type: number
        default: 12
      next_update_min:
        description: "UTC minute for Next Update text fallback"
        type: number
        default: 15

permissions:
  contents: write

# ğŸ”’ One writer to main across ALL workflows
concurrency:
  group: repo-main-writer
  cancel-in-progress: true

jobs:
  update-readme:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    env:
      # Inputs
      BANNER_MODE: ${{ github.event.inputs.banner_mode || 'sequential' }}
      BANNER_CALENDAR_MODE: ${{ (github.event.inputs.banner_mode || '') == 'calendar' }}
      MLOPS_INSIGHT: ${{ github.event.inputs.insight || '' }}
      BANNER_EMOJI_MODE: "stable"
      BANNER_EMOJIS: ${{ github.event.inputs.emojis || 'ğŸï¸,â˜•,ğŸª„,ğŸ¤–,ğŸŒ…,ğŸŒ‡,ğŸ“Š,ğŸŒŠ,ğŸŒˆ,âš¡' }}

      JSONL_KEEP_LINES: ${{ github.event.inputs.jsonl_keep_lines || 200 }}
      TXT_KEEP_LINES: ${{ github.event.inputs.txt_keep_lines || 70 }}
      LOG_TABLE_N: ${{ github.event.inputs.table_n || 5 }}
      COMMIT_MODE: ${{ github.event.inputs.commit_mode || 'auto' }}

      # Schedule badge display
      SCHEDULE_BADGE: "24h_5m"

      # Fallback next-update text calc (if next_update.json missing or unreadable)
      NEXT_UPDATE_HOUR: ${{ github.event.inputs.next_update_hour || 12 }}
      NEXT_UPDATE_MIN: ${{ github.event.inputs.next_update_min || 15 }}

      # Jitter (seconds) - safe when 0
      JITTER_MAX_SEC: 600

      # Safety
      CURL_RETRY: "3"
      CURL_DELAY: "2"

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Checkout + pre-sync (fast + consistent)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout (shallow, but push-safe)
        uses: actions/checkout@v5
        with:
          ref: main
          fetch-depth: 0
          persist-credentials: true

      - name: Pre-sync with origin/main (hard reset, no rebase)
        shell: bash
        run: |
          set -euo pipefail
          git fetch --no-tags origin main
          git reset --hard origin/main

      - name: Ensure dirs + bootstrap files
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .ci badges logs

          # Bootstrap logs if missing
          [ -f update_log.jsonl ] || : > update_log.jsonl
          [ -f update_log.txt  ] || : > update_log.txt

          # Bootstrap next_update.json only if missing (badge workflow OWNS it; we won't commit it)
          if [ ! -f badges/next_update.json ]; then
            echo '{"schemaVersion":1,"label":"Next Update","message":"â€”","color":"lightgrey","labelColor":"e5e7eb","namedLogo":"timer"}' > badges/next_update.json
          fi

      - name: Random jitter (schedule only)
        if: ${{ github.event_name == 'schedule' }}
        shell: bash
        run: |
          set -euo pipefail
          max="${JITTER_MAX_SEC:-0}"
          if [[ "$max" -gt 0 ]]; then
            s=$(( RANDOM % (max + 1) ))
            echo "Sleeping ${s}s to spread load..."
            sleep "$s"
          fi

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Python setup
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.10"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Configure Git author (stable)
        shell: bash
        run: |
          set -euo pipefail
          git config --global user.name  "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Install Python deps (optional)
        if: hashFiles('requirements.txt') != ''
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Core update script
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run updater (with logs)
        shell: bash
        run: |
          set -euo pipefail
          python update_readme.py 2>&1 | tee logs/updater.out

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Compute TOTAL_UPDATES and NEXT_UPDATE_TEXT (no jq required)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Read totals & compute NEXT_UPDATE_TEXT
        shell: bash
        run: |
          set -euo pipefail
          ENV_FILE="$GITHUB_ENV"

          if [[ -f .ci/update_count.txt ]]; then
            echo "TOTAL_UPDATES=$(tr -d '\r\n' < .ci/update_count.txt)" >> "$ENV_FILE"
          fi

          msg="$(python - <<'PY'
import json
try:
  with open("badges/next_update.json","r",encoding="utf-8") as f:
    data=json.load(f)
  print((data.get("message") or "").strip())
except Exception:
  print("")
PY
)"
          if [[ -z "$msg" ]]; then
            H=${NEXT_UPDATE_HOUR:-12}
            M=${NEXT_UPDATE_MIN:-15}
            now=$(date -u +%s)
            target=$(date -u -d "$(date -u +%Y-%m-%d) $H:$M:00" +%s 2>/dev/null || echo 0)
            if (( now >= target )); then
              target=$(date -u -d "tomorrow $H:$M:00" +%s)
            fi
            diff=$(( target - now ))
            if (( diff < 3600 )); then
              mins=$(( diff / 60 ))
              msg="in ${mins}m"
            else
              hours=$(( diff / 3600 ))
              mins=$(( (diff % 3600) / 60 ))
              msg="in ${hours}h $(printf '%02d' "$mins")m"
            fi
          fi

          echo "NEXT_UPDATE_TEXT=$msg" >> "$ENV_FILE"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Metrics badges (followers/stars/updates) â€” FIXED
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Update GitHub metrics badges (followers/stars/updates)
        env:
          GH_USER: evgeniimatveev
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p badges
          UA="gh-actions-readme-badges"

          export FOLLOWERS_JSON="$(curl -fsSL --retry "${CURL_RETRY}" --retry-delay "${CURL_DELAY}" --retry-all-errors \
            -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github+json" -H "User-Agent: $UA" \
            "https://api.github.com/users/${GH_USER}")"

          export REPOS_JSON="$(curl -fsSL --retry "${CURL_RETRY}" --retry-delay "${CURL_DELAY}" --retry-all-errors \
            -H "Authorization: Bearer $GH_TOKEN" -H "Accept: application/vnd.github+json" -H "User-Agent: $UA" \
            "https://api.github.com/search/repositories?q=user:${GH_USER}+fork:false&per_page=100")"

          python - <<'PY'
import json, os

followers_json=os.environ.get("FOLLOWERS_JSON","{}")
repos_json=os.environ.get("REPOS_JSON","{}")

f=json.loads(followers_json).get("followers",0)
items=json.loads(repos_json).get("items",[])
stars=sum(int(x.get("stargazers_count",0)) for x in items)

total=os.environ.get("TOTAL_UPDATES","?")

def write(path, d):
  with open(path,"w",encoding="utf-8") as fp:
    json.dump(d, fp, separators=(",",":"))

write("badges/github_followers.json", {"schemaVersion":1,"label":"followers","message":str(f),"color":"blue"})
write("badges/github_stars.json", {"schemaVersion":1,"label":"stars","message":str(stars),"color":"yellow"})
write("badges/total_updates.json", {"schemaVersion":1,"label":"updates","message":str(total),"color":"0ea5e9"})
PY

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Ensure README markers exist (prevents â€œno-opâ€ awk)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Ensure README blocks exist (STATUS/STATUS2/BADGES/LOG)
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
from pathlib import Path

p=Path("README.md")
txt=p.read_text(encoding="utf-8") if p.exists() else ""

def ensure_block(start, end):
  global txt
  if start not in txt:
    txt = (txt.rstrip() + f"\n\n{start}\n{end}\n") if txt.strip() else f"{start}\n{end}\n"

ensure_block("<!-- STATUS:START -->","<!-- STATUS:END -->")
ensure_block("<!-- STATUS2:START -->","<!-- STATUS2:END -->")
ensure_block("<!-- BADGES:START -->","<!-- BADGES:END -->")
ensure_block("<!-- LOG:START -->","<!-- LOG:END -->")

p.write_text(txt, encoding="utf-8")
PY

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # BADGES block (vertical)
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Ensure BADGES block (vertical)
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
import os, pathlib, re

repo=os.getenv("GITHUB_REPOSITORY")
ref=os.getenv("GITHUB_REF_NAME")
t=os.getenv("GITHUB_RUN_NUMBER","0")

last=f"https://img.shields.io/github/last-commit/{repo}?color=red&style=for-the-badge&t={t}"
followers=f"https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/{repo}/{ref}/badges/github_followers.json&style=for-the-badge&cacheSeconds=600&t={t}"
stars=f"https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/{repo}/{ref}/badges/github_stars.json&style=for-the-badge&cacheSeconds=600&t={t}"
total=f"https://img.shields.io/endpoint?url=https://raw.githubusercontent.com/{repo}/{ref}/badges/total_updates.json&style=for-the-badge&cacheSeconds=120&t={t}"

block=f"""<!-- BADGES:START -->
<div align="left">
<p><img src="{last}" alt="Last Commit"></p>
<p><img src="{followers}" alt="GitHub Followers"></p>
<p><img src="{stars}" alt="GitHub Stars"></p>
<p><img src="{total}" alt="Total Updates"></p>
</div>
<!-- BADGES:END -->"""

p=pathlib.Path("README.md")
txt=p.read_text(encoding="utf-8")
txt=re.sub(r"<!-- BADGES:START -->.*?<!-- BADGES:END -->", block, txt, flags=re.S)
p.write_text(txt, encoding="utf-8")
PY

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Logs maintenance
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Append & trim update_log.txt
        shell: bash
        run: |
          set -euo pipefail
          {
            echo "--------------------------------------"
            echo "Updated on: $(date -u) (UTC)"
            echo "Triggered by: ${{ github.event_name }}"
            echo "Commit SHA: ${{ github.sha }}"
            echo "Run ID: ${{ github.run_id }}"
            echo "Run number: ${{ github.run_number }}"
            echo "--------------------------------------"
          } >> update_log.txt
          tail -n "${TXT_KEEP_LINES}" update_log.txt > update_log.txt.tmp || true
          mv update_log.txt.tmp update_log.txt || true

      - name: Trim JSON log (keep last N lines)
        shell: bash
        run: |
          set -euo pipefail
          tail -n "${JSONL_KEEP_LINES}" update_log.jsonl > update_log.jsonl.tmp || true
          mv update_log.jsonl.tmp update_log.jsonl || true

      - name: Render last N updates into README (accordion)
        shell: bash
        run: |
          set -euo pipefail
          python - <<'PY'
import json, pathlib, re, os

N=int(os.getenv("LOG_TABLE_N","5"))
log=pathlib.Path("update_log.jsonl")
p=pathlib.Path("README.md")

def esc(s): 
  return str(s).replace("|","&#124;").replace("\n"," ").strip()

rows=[]
if log.exists():
  lines=[l for l in log.read_text(encoding="utf-8").splitlines() if l.strip()][-N:]
  for line in reversed(lines):
    d=json.loads(line)
    b=f"{d.get('banner_index','?')}/{d.get('banner_total','?')} ({d.get('banner_file','')})"
    ins=esc(d.get('insight_preview',''))
    if len(ins)>140: ins=ins[:137]+"â€¦"
    rows.append(f"| {esc(d.get('ts_utc',''))} | {esc(d.get('run_number',''))} | `{esc(d.get('sha',''))}` | {esc(b)} | {esc(d.get('event',''))}/{esc(d.get('actor',''))} | {ins} |")

headers=["Time (UTC)","Run","SHA","Banner","Event/Actor","Insight"]
sep="|"+"|".join(["---"]*len(headers))+"|"
table=[
  f"<details><summary>ğŸ—‚ï¸<b>Recent updates (last {N})</b></summary>",
  "",
  "| "+" | ".join(headers)+"|",
  sep,
  *(rows or ["| â€” | â€” | â€” | â€” | â€” | â€” |"]),
  "",
  "</details>"
]
block="<!-- LOG:START -->\n"+"\n".join(table)+"\n<!-- LOG:END -->"

txt=p.read_text(encoding="utf-8")
txt=re.sub(r"<!-- LOG:START -->.*?<!-- LOG:END -->", block, txt, flags=re.S)
p.write_text(txt, encoding="utf-8")
PY

      - name: Update STATUS line in README
        shell: bash
        run: |
          set -euo pipefail
          short_sha="${GITHUB_SHA:0:7}"
          NOW_UTC="$(date -u +"%Y-%m-%d %H:%M UTC")"
          NOW_BADGE="$(printf "%s" "$NOW_UTC" | sed 's/ /%20/g; s/:/%3A/g')"
          MODE_BADGE="${COMMIT_MODE}"
          NEXT_ENDPOINT="https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/${GITHUB_REF_NAME}/badges/next_update.json"
          SMOKE_LINK="https://github.com/${GITHUB_REPOSITORY}/actions/workflows/smoke.yml"
          SMOKE_BADGE="${SMOKE_LINK}/badge.svg?branch=${GITHUB_REF_NAME}&t=${GITHUB_RUN_NUMBER}"

          STATUS="<p align=\"center\">
<img src=\"https://img.shields.io/static/v1?label=Updated&message=${NOW_BADGE}&color=0e8a16&labelColor=30363d&logo=clock&cacheSeconds=60&t=${GITHUB_RUN_NUMBER}\" />
<img src=\"https://img.shields.io/badge/Schedule-${SCHEDULE_BADGE}-2ea44f?cacheSeconds=300\" />
<img src=\"https://img.shields.io/endpoint?url=${NEXT_ENDPOINT}&cacheSeconds=120&t=${GITHUB_RUN_NUMBER}\" />
<img src=\"https://img.shields.io/static/v1?label=Next%20Update&message=${NEXT_UPDATE_TEXT// /%20}&color=757575&labelColor=30363d&cacheSeconds=600\" />
<img src=\"https://img.shields.io/badge/Rotation-%23${GITHUB_RUN_NUMBER}-1f6feb?cacheSeconds=60\" />
<img src=\"https://img.shields.io/badge/Commit-${short_sha}-9cf?cacheSeconds=300\" />
<img src=\"https://img.shields.io/static/v1?label=Updates&message=${TOTAL_UPDATES:-?}&color=0ea5e9&cacheSeconds=300\" />
<img src=\"https://img.shields.io/badge/Event-${GITHUB_EVENT_NAME}-8a2be2?cacheSeconds=300\" />
<img src=\"https://img.shields.io/badge/Mode-${MODE_BADGE}-grey?cacheSeconds=60\" />
<a href=\"${SMOKE_LINK}\"><img src=\"${SMOKE_BADGE}\" alt=\"Daily Smoke\" /></a>
</p>"

          awk -v r="$STATUS" '
            /<!-- STATUS:START -->/ {print; print r; f=1; next}
            /<!-- STATUS:END -->/   {f=0}
            !f
          ' README.md > README.tmp && mv README.tmp README.md

      - name: Update STATUS2 line in README
        shell: bash
        run: |
          set -euo pipefail
          NEXT_ENDPOINT="https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/${GITHUB_REF_NAME}/badges/next_update.json"
          SMOKE_LINK="https://github.com/${GITHUB_REPOSITORY}/actions/workflows/smoke.yml"
          SMOKE_BADGE="${SMOKE_LINK}/badge.svg?branch=${GITHUB_REF_NAME}&t=${GITHUB_RUN_NUMBER}"

          LOW_STATUS="<p align=\"left\">
<img src=\"https://img.shields.io/endpoint?url=${NEXT_ENDPOINT}&cacheSeconds=120&t=${GITHUB_RUN_NUMBER}\" />
<img src=\"https://img.shields.io/static/v1?label=Next%20Update&message=${NEXT_UPDATE_TEXT// /%20}&color=757575&labelColor=30363d&cacheSeconds=600\" />
<img src=\"https://img.shields.io/static/v1?label=Updates&message=${TOTAL_UPDATES:-?}&color=0ea5e9&labelColor=30363d&cacheSeconds=300\" />
<a href=\"${SMOKE_LINK}\"><img src=\"${SMOKE_BADGE}\" alt=\"Daily Smoke\" /></a>
</p>"

          awk -v r="$LOW_STATUS" '
            /<!-- STATUS2:START -->/ {print; print r; f=1; next}
            /<!-- STATUS2:END -->/   {f=0}
            !f
          ' README.md > README.tmp && mv README.tmp README.md

      - name: Heartbeat (force diff on schedule/force)
        if: ${{ github.event_name == 'schedule' || env.COMMIT_MODE == 'force' }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .ci
          echo "$(date -u +'%Y-%m-%d %H:%M:%S') UTC  run=${GITHUB_RUN_NUMBER} sha=${GITHUB_SHA:0:7}" >> .ci/heartbeat.log

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Commit + push (conflict-proof) â€” cherry-pick strategy
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Commit changes (if any)
        id: commit
        if: env.COMMIT_MODE != 'dry-run'
        shell: bash
        run: |
          set -euo pipefail

          # NOTE: this workflow does NOT add badges/next_update.json (owned by badge workflow).
          git add README.md update_log.txt update_log.jsonl .ci/heartbeat.log .ci/update_count.txt \
                 badges/github_followers.json badges/github_stars.json badges/total_updates.json logs/updater.out 2>/dev/null || true

          if git diff --cached --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No changes to commit."
            exit 0
          fi

          msg="Auto-update README (banner/status/insight rotation + logs) [v7.7.0]"
          if [ "${COMMIT_MODE}" = "force" ]; then msg="${msg} [force]"; fi
          git commit -m "$msg"
          echo "changed=true" >> "$GITHUB_OUTPUT"

      - name: Push changes (conflict-proof, no rebase)
        if: env.COMMIT_MODE != 'dry-run' && steps.commit.outputs.changed == 'true'
        shell: bash
        run: |
          set -euo pipefail
          COMMIT_SHA="$(git rev-parse HEAD)"

          for i in 1 2 3; do
            echo "Attempt $i: syncing to origin/main..."
            git fetch --no-tags origin main
            git reset --hard origin/main

            # Re-apply our commit on top of latest remote main
            if ! git cherry-pick "$COMMIT_SHA"; then
              echo "Cherry-pick conflict. Aborting and retrying..."
              git cherry-pick --abort || true
              sleep $((i*3))
              continue
            fi

            if git push origin HEAD:main; then
              echo "Pushed successfully"
              exit 0
            fi

            echo "Push failed. Retrying..."
            sleep $((i*3))
          done

          echo "Push failed after 3 attempts"
          exit 1

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Debug/summary + artifacts
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Show updater tail
        if: always()
        shell: bash
        run: |
          if [ -f logs/updater.out ]; then
            echo "=== updater.out (last 120 lines) ==="
            tail -n 120 logs/updater.out
          else
            echo "logs/updater.out not found"
          fi

      - name: Write job summary
        if: always()
        shell: bash
        run: |
          {
            echo "## README Auto-Update v7.7.0"
            echo "- **Run**: #${{ github.run_number }}"
            echo "- **Event**: ${{ github.event_name }}"
            echo "- **Mode**: ${COMMIT_MODE}"
            echo "- **Schedule**: ${SCHEDULE_BADGE}"
            echo "- **Total Updates**: ${TOTAL_UPDATES:-?}"
            echo "- **Next Update (text)**: ${NEXT_UPDATE_TEXT}"
            echo "- **Concurrency group**: repo-main-writer"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload logs as artifacts
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: update_logs
          path: |
            logs/updater.out
            logs/updater.out
            update_log.txt
            update_log.jsonl
            .ci/heartbeat.log
            .ci/update_count.txt
            badges/github_followers.json
            badges/github_stars.json
            badges/total_updates.json
          retention-days: 7
