name: Auto Update README

on:
  schedule:
    # Run once a day at 09:05 UTC
    - cron: "5 9 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: auto-update-readme
  cancel-in-progress: false

jobs:
  update-readme:
    runs-on: ubuntu-latest

    env:
      # Controls for the updater script
      BANNER_MODE: sequential
      # If you want rotation to advance even when a run was skipped, enable:
      # BANNER_CALENDAR_MODE: "true"
      # Shown in STATUS and Run Meta blocks:
      SCHEDULE_BADGE: "24h_5m"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Configure Git author
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

      # Run your updater (rotates banner, timestamps, quote, writes JSONL line, etc.)
      - name: Run updater
        run: python update_readme.py

      # Append run metadata to a small text log and keep it compact
      - name: Append & trim update_log.txt
        shell: bash
        run: |
          {
            echo "--------------------------------------"
            echo "Updated on: $(date -u) (UTC)"
            echo "Triggered by: ${{ github.event_name }}"
            echo "Commit SHA: ${{ github.sha }}"
            echo "Run ID: ${{ github.run_id }}"
            echo "Run number: ${{ github.run_number }}"
            echo "--------------------------------------"
          } >> update_log.txt
          # Keep last ~70 lines
          tail -n 70 update_log.txt > temp_log.txt || true
          mv temp_log.txt update_log.txt || true

      # Keep JSONL log short and readable
      - name: Trim JSON log (keep last ~200 lines)
        shell: bash
        run: |
          [ -f update_log.jsonl ] || : > update_log.jsonl
          tail -n 200 update_log.jsonl > update_log.jsonl.tmp || true
          mv update_log.jsonl.tmp update_log.jsonl || true

      # Render last 5 JSONL entries into README as an accordion table
      - name: Render last 5 updates into README (accordion)
        shell: bash
        run: |
          python - <<'PY'
          import json, pathlib, re

          log = pathlib.Path("update_log.jsonl")
          readme_p = pathlib.Path("README.md")

          def esc_md(s: str) -> str:
              # Safe for GitHub tables; keeps columns intact without extra backslashes
              s = str(s).replace("|", "&#124;").replace("\n", " ").strip()
              return s

          rows = []
          if log.exists():
              lines = [l for l in log.read_text(encoding="utf-8").splitlines() if l.strip()][-5:]
              for line in reversed(lines):
                  d = json.loads(line)

                  insight = esc_md(d.get("insight_preview",""))
                  # Soft-truncate to 140 chars so the table remains tidy
                  if len(insight) > 140:
                      insight = insight[:137] + "…"

                  row = (
                      f"| {esc_md(d.get('ts_utc',''))}"
                      f" | {esc_md(d.get('run_number',''))}"
                      f" | `{esc_md(d.get('sha',''))}`"
                      f" | {esc_md(f\"{d.get('banner_index','?')}/{d.get('banner_total','?')} ({d.get('banner_file','')})\")}"
                      f" | {esc_md(d.get('event',''))}/{esc_md(d.get('actor',''))}"
                      f" | {insight} |"
                  )
                  rows.append(row)

          # Headers and correct separator for 6 columns
          headers = ["Time (UTC)", "Run", "SHA", "Banner", "Event/Actor", "Insight"]
          sep = "|" + "|".join(["---"] * len(headers)) + "|"

          table = [
              "<details><summary><b>Recent updates (last 5)</b></summary>",
              "",
              "| " + " | ".join(headers) + " |",
              sep,
              *(rows or ["| — | — | — | — | — | — |"]),
              "",
              "</details>",
          ]
          new_block = "\n".join(["<!-- LOG:START -->", *table, "<!-- LOG:END -->"])

          readme = readme_p.read_text(encoding="utf-8")
          if re.search(r"<!-- LOG:START -->.*?<!-- LOG:END -->", readme, flags=re.S):
              readme = re.sub(r"<!-- LOG:START -->.*?<!-- LOG:END -->", new_block, readme, flags=re.S)
          else:
              readme = readme.rstrip() + "\n\n" + new_block + "\n"

          readme_p.write_text(readme, encoding="utf-8")
          PY

      # Refresh STATUS badges in README (uses SCHEDULE_BADGE + current run/time)
      - name: Update STATUS line in README
        shell: bash
        run: |
          short_sha="${GITHUB_SHA:0:7}"
          NOW_UTC="$(date -u +"%Y-%m-%d %H:%M UTC")"
          NOW_BADGE=$(printf "%s" "$NOW_UTC" | sed 's/ /%20/g; s/:/%3A/g')
          STATUS="<p align=\"center\">
          <img src=\"https://img.shields.io/static/v1?label=Updated&message=${NOW_BADGE}&color=0e8a16&labelColor=30363d&logo=clock&cacheSeconds=60&t=${GITHUB_RUN_NUMBER}\" />
          <img src=\"https://img.shields.io/badge/Schedule-${SCHEDULE_BADGE}-2ea44f?cacheSeconds=300\" />
          <img src=\"https://img.shields.io/badge/Rotation-%23${GITHUB_RUN_NUMBER}-1f6feb?cacheSeconds=60\" />
          <img src=\"https://img.shields.io/badge/Commit-${short_sha}-9cf?cacheSeconds=300\" />
          <img src=\"https://img.shields.io/badge/Event-${GITHUB_EVENT_NAME}-8a2be2?cacheSeconds=300\" />
          </p>"
          awk -v r="$STATUS" '
            /<!-- STATUS:START -->/ {print; print r; f=1; next}
            /<!-- STATUS:END -->/   {f=0}
            !f
          ' README.md > README.tmp && mv README.tmp README.md

      # Only commit if there are actual changes
      - name: Commit changes (if any)
        id: commit
        shell: bash
        run: |
          set -e
          git add README.md update_log.txt || true
          if git diff --cached --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No changes to commit."
          else
            git commit -m "Auto-update README (banner/status/insight rotation)"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      # Push with a couple of retries to avoid rare race conditions
      - name: Push changes
        if: steps.commit.outputs.changed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          for i in 1 2 3; do
            if git push; then
              echo "Pushed successfully"
              break
            fi
            echo "Push failed (attempt $i). Retrying in $((i*3))s..."
            sleep $((i*3))
            git pull --rebase || true
          done

      # Nice summary in the run view
      - name: Write job summary
        shell: bash
        run: |
          {
            echo "## README Auto-Update"
            echo "- **Run**: #${{ github.run_number }}"
            echo "- **Event**: ${{ github.event_name }}"
            echo "- **Commit**: ${{ github.sha }}"
            echo "- **Schedule**: ${SCHEDULE_BADGE}"
            echo "- Pushed: $([[ '${{ steps.commit.outputs.changed }}' == 'true' ]] && echo '✅' || echo '—')"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload logs as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: update_logs
          path: |
            update_log.txt
            update_log.jsonl
          retention-days: 7
