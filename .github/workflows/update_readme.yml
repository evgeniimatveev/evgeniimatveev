name: Auto Update README

on:
  schedule:
    - cron: "5 */6 * * *" # Run every 6 hours      # Run every hour  "0 */1 * * *"
  workflow_dispatch:          # Allow manual runs from the Actions tab

# Prevent concurrent runs of this workflow from racing on README changes
concurrency:
  group: auto-update-readme
  cancel-in-progress: false

jobs:
  update-readme:
    runs-on: ubuntu-latest
    env:
      # Optional: if your Python script supports it, you can read this to switch modes
      BANNER_MODE: sequential

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false   # We'll push with PAT explicitly
          fetch-depth: 0               # Needed so Git has history for commits

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

  

      - name: Run updater (updates banner + timestamp + quote)
        run: python update_readme.py

      - name: Configure Git author
        run: |
          git config --global user.name "evgeniimatveev"
          git config --global user.email "your-email@users.noreply.github.com"

      - name: Append run metadata to log
        run: |
          {
            echo "--------------------------------------"
            echo "Updated on: $(date -u) (UTC)"
            echo "Triggered by: ${{ github.event_name }}"
            echo "Commit SHA: ${{ github.sha }}"
            echo "Run ID: ${{ github.run_id }}"
            echo "Run number: ${{ github.run_number }}"
            echo "--------------------------------------"
          } >> update_log.txt

      - name: Trim log (keep last ~70 lines)
        run: |
          tail -n 70 update_log.txt > temp_log.txt || true
          mv temp_log.txt update_log.txt || true

      - name: Update STATUS line in README
        shell: bash
        run: |
          short_sha="${GITHUB_SHA:0:7}"
          STATUS="<p align=\"center\"><sub>📟 Auto-updated every 6 h 5 m · Rotation #${GITHUB_RUN_NUMBER} · RunID ${GITHUB_RUN_ID} · Commit ${short_sha} · Event ${GITHUB_EVENT_NAME}</sub></p>"
          perl -0777 -pe "s/<!-- STATUS:START -->.*?<!-- STATUS:END -->/<!-- STATUS:START -->\n$STATUS\n<!-- STATUS:END -->/s" README.md > README.tmp
          mv README.tmp README.md

      
      - name: Commit & push changes
        env:
          GITHUB_TOKEN: ${{ secrets.CLASSIC_PAT }}   # Personal access token with 'repo' scope
        run: |
          git add README.md update_log.txt || true
          git commit -m "Auto-update README (sequential rotation)" || echo "No changes to commit"
          git push "https://x-access-token:${{ secrets.CLASSIC_PAT }}@github.com/${{ github.repository }}.git" HEAD:main
