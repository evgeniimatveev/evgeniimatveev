name: Update GitHub Metrics (local SVG)

on:
  workflow_dispatch:
  schedule:
    - cron: "23 10 * * 1" # weekly on Monday (UTC)

permissions:
  contents: write

concurrency:
  group: profile-readme-updates
  cancel-in-progress: false

jobs:
  metrics:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure metrics folder exists
        run: mkdir -p metrics

      - name: Generate metrics SVG (Docker, auto-find output)
        env:
          METRICS_TOKEN: ${{ secrets.CLASSIC_PAT }}
        run: |
          set -euo pipefail

          CID=$(docker create \
            -e INPUT_USER=evgeniimatveev \
            -e INPUT_TOKEN="${METRICS_TOKEN}" \
            -e INPUT_FILENAME="github-metrics.svg" \
            -e INPUT_TEMPLATE="terminal" \
            -e INPUT_THEME="tokyonight" \
            -e INPUT_BASE="header,activity,community,repositories" \
            -e INPUT_PLUGIN_ISOCALENDAR="yes" \
            -e INPUT_PLUGIN_ISOCALENDAR_DURATION="full-year" \
            -e INPUT_PLUGIN_LANGUAGES="yes" \
            -e INPUT_PLUGIN_LANGUAGES_DETAILS="yes" \
            -e INPUT_PLUGIN_LANGUAGES_INDEPTH="no" \
            -e INPUT_PLUGIN_LANGUAGES_LIMIT="6" \
            -e INPUT_CONFIG_TIMEZONE="UTC" \
            ghcr.io/lowlighter/metrics:latest)

          # Run container (may exit non-zero even when output exists)
          docker start -a "${CID}" || true

          echo "ðŸ”Ž Searching for generated SVG inside container..."
          # Find the svg anywhere (limit to first hit)
          SVG_PATH=$(docker exec "${CID}" sh -lc 'find / -maxdepth 6 -type f -name "github-metrics.svg" 2>/dev/null | head -n 1' || true)

          if [ -z "${SVG_PATH}" ]; then
            echo "âŒ Could not find github-metrics.svg inside container."
            echo "Debug: listing common dirs:"
            docker exec "${CID}" sh -lc 'ls -la / 2>/dev/null || true; ls -la /metrics_renders 2>/dev/null || true; ls -la /output 2>/dev/null || true'
            docker rm -f "${CID}" >/dev/null 2>&1 || true
            exit 1
          fi

          echo "âœ… Found SVG at: ${SVG_PATH}"
          docker cp "${CID}:${SVG_PATH}" "metrics/github-metrics.svg"

          docker rm -f "${CID}" >/dev/null 2>&1 || true

          test -s "metrics/github-metrics.svg"
          echo "âœ… Saved to metrics/github-metrics.svg"

      - name: Commit changes (only if changed)
        run: |
          set -euo pipefail

          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add metrics/github-metrics.svg
          git commit -m "chore: update github metrics (local)"
          git push
