name: Update GitHub Metrics (local SVG)

on:
  workflow_dispatch:
  schedule:
    - cron: "23 10 * * 1" # weekly on Monday (UTC)

permissions:
  contents: write

concurrency:
  group: profile-readme-updates
  cancel-in-progress: false

jobs:
  metrics:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure metrics folder exists
        run: mkdir -p metrics

      - name: Generate metrics SVG (Docker + docker cp)
        env:
          METRICS_TOKEN: ${{ secrets.CLASSIC_PAT }}
        run: |
          set -euo pipefail

          CID=$(docker create \
            -e INPUT_USER=evgeniimatveev \
            -e INPUT_TOKEN="${METRICS_TOKEN}" \
            -e INPUT_FILENAME="github-metrics.svg" \
            -e INPUT_TEMPLATE="terminal" \
            -e INPUT_THEME="tokyonight" \
            -e INPUT_BASE="header,activity,community,repositories" \
            -e INPUT_PLUGIN_ISOCALENDAR="yes" \
            -e INPUT_PLUGIN_ISOCALENDAR_DURATION="full-year" \
            -e INPUT_PLUGIN_LANGUAGES="yes" \
            -e INPUT_PLUGIN_LANGUAGES_DETAILS="yes" \
            -e INPUT_PLUGIN_LANGUAGES_INDEPTH="no" \
            -e INPUT_PLUGIN_LANGUAGES_LIMIT="6" \
            -e INPUT_CONFIG_TIMEZONE="UTC" \
            ghcr.io/lowlighter/metrics:latest)

          # Run (container will exit when done)
          docker start -a "${CID}" || true

          # Try to copy from the most common output dirs (works even if container is stopped)
          rm -f metrics/github-metrics.svg
          rm -rf /tmp/metrics_out
          mkdir -p /tmp/metrics_out

          echo "ðŸ“¦ Trying to copy /metrics_renders..."
          docker cp "${CID}:/metrics_renders" "/tmp/metrics_out/metrics_renders" 2>/dev/null || true

          echo "ðŸ“¦ Trying to copy /output..."
          docker cp "${CID}:/output" "/tmp/metrics_out/output" 2>/dev/null || true

          # Find the file in copied dirs
          SVG_PATH=$(find /tmp/metrics_out -type f -name "github-metrics.svg" 2>/dev/null | head -n 1 || true)

          if [ -z "${SVG_PATH}" ]; then
            echo "âŒ Could not locate github-metrics.svg in copied outputs."
            echo "Debug tree:"
            find /tmp/metrics_out -maxdepth 4 -type f 2>/dev/null || true
            docker rm -f "${CID}" >/dev/null 2>&1 || true
            exit 1
          fi

          cp "${SVG_PATH}" "metrics/github-metrics.svg"
          docker rm -f "${CID}" >/dev/null 2>&1 || true

          test -s "metrics/github-metrics.svg"
          echo "âœ… Saved to metrics/github-metrics.svg"

      - name: Commit changes (only if changed)
        run: |
          set -euo pipefail

          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add metrics/github-metrics.svg
          git commit -m "chore: update github metrics (local)"
          git push
