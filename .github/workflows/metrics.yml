name: Update GitHub Metrics (local SVG)

on:
  workflow_dispatch:
  schedule:
    - cron: "23 10 * * *" # daily (UTC)

permissions:
  contents: write

concurrency:
  group: profile-readme-updates
  cancel-in-progress: false

jobs:
  metrics:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure metrics folder exists
        run: mkdir -p metrics

      - name: Generate metrics SVG (Docker, no third-party action)
        env:
          METRICS_TOKEN: ${{ secrets.CLASSIC_PAT }}
        run: |
          set -euo pipefail

          # Generate SVG into the repository workspace (mounted into the container)
          docker run --rm \
            -e INPUT_USER=evgeniimatveev \
            -e INPUT_TOKEN="${METRICS_TOKEN}" \
            -e INPUT_FILENAME="/repo/metrics/github-metrics.svg" \
            -e INPUT_TEMPLATE="terminal" \
            -e INPUT_THEME="tokyonight" \
            -e INPUT_BASE="header,activity,community,repositories" \
            -e INPUT_PLUGIN_ISOCALENDAR="yes" \
            -e INPUT_PLUGIN_ISOCALENDAR_DURATION="full-year" \
            -e INPUT_PLUGIN_LANGUAGES="yes" \
            -e INPUT_PLUGIN_LANGUAGES_DETAILS="yes" \
            -e INPUT_PLUGIN_LANGUAGES_INDEPTH="yes" \
            -e INPUT_PLUGIN_LANGUAGES_LIMIT="6" \
            -e INPUT_CONFIG_TIMEZONE="UTC" \
            -v "${GITHUB_WORKSPACE}:/repo" \
            ghcr.io/lowlighter/metrics:latest

          # Sanity check (fail fast if file wasn't created)
          test -s "metrics/github-metrics.svg"
          echo "âœ… Generated metrics/github-metrics.svg"

      - name: Commit changes (only if changed)
        run: |
          set -euo pipefail

          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add metrics/github-metrics.svg
          git commit -m "chore: update github metrics (local)"
          git push
