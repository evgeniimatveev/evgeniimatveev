name: Update GitHub Metrics (local SVG)

on:
  workflow_dispatch:
  schedule:
    - cron: "23 10 * * 1" # weekly on Monday (UTC)

permissions:
  contents: write

concurrency:
  group: profile-readme-updates
  cancel-in-progress: false

jobs:
  metrics:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure metrics folder exists
        run: mkdir -p metrics

      - name: Generate metrics SVG (Docker + docker cp, stable)
        env:
          METRICS_TOKEN: ${{ secrets.CLASSIC_PAT }}
        run: |
          set -euo pipefail

          # Create container (do not rely on volume mount for output)
          CID=$(docker create \
            -e INPUT_USER=evgeniimatveev \
            -e INPUT_TOKEN="${METRICS_TOKEN}" \
            -e INPUT_FILENAME="github-metrics.svg" \
            -e INPUT_TEMPLATE="terminal" \
            -e INPUT_THEME="tokyonight" \
            -e INPUT_BASE="header,activity,community,repositories" \
            -e INPUT_PLUGIN_ISOCALENDAR="yes" \
            -e INPUT_PLUGIN_ISOCALENDAR_DURATION="full-year" \
            -e INPUT_PLUGIN_LANGUAGES="yes" \
            -e INPUT_PLUGIN_LANGUAGES_DETAILS="yes" \
            -e INPUT_PLUGIN_LANGUAGES_INDEPTH="no" \
            -e INPUT_PLUGIN_LANGUAGES_LIMIT="6" \
            -e INPUT_CONFIG_TIMEZONE="UTC" \
            ghcr.io/lowlighter/metrics:latest)

          # Run container (it may exit with non-zero even if SVG is produced)
          docker start -a "${CID}" || true

          # Extract SVG from container (based on your logs: /metrics_renders/github-metrics.svg)
          docker cp "${CID}:/metrics_renders/github-metrics.svg" "metrics/github-metrics.svg"

          # Cleanup
          docker rm -f "${CID}" >/dev/null 2>&1 || true

          # Validate output exists
          test -s "metrics/github-metrics.svg"
          echo "âœ… Generated metrics/github-metrics.svg"

      - name: Commit changes (only if changed)
        run: |
          set -euo pipefail

          if git diff --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add metrics/github-metrics.svg
          git commit -m "chore: update github metrics (local)"
          git push
