name: Generate Snake

on:
  workflow_dispatch:
  schedule:
    - cron: "30 0 * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1) Generate all 7 snake variants (A–G) using YOUR fork
     - name: Generate snake variants (A–G)
        uses: evgeniimatveev/snk/svg-only@main
        with:
          github_user_name: evgeniimatveev
          outputs: |
            dist/snake-a.svg?palette=github-dark&color_snake=%23ff66c4&color_dots=%230e4429,%23006d32,%2326a641,%2339d353
            dist/snake-b.svg?palette=github-dark&color_snake=%235fd1ff&color_dots=%230b1020,%23004d75,%230094d4,%234dd2ff
            dist/snake-c.svg?palette=github-dark&color_snake=%23ffb86c&color_dots=%2322130b,%237c3f00,%23ff9f1a,%23ffd27f
            dist/snake-d.svg?palette=github-dark&color_snake=%23ff79c6&color_dots=%23251022,%239b287b,%23ff4fa3,%23ffc1e3
            dist/snake-e.svg?palette=github-dark&color_snake=%23a2ff5e&color_dots=%23101a0c,%233f6f22,%2371c837,%23c9ff9d
            dist/snake-f.svg?palette=github-dark&color_snake=%23ffd166&color_dots=%23261a00,%238c5e00,%23ffba08,%23ffe08a
            dist/snake-g.svg?palette=github-dark&color_snake=%2364fff2&color_dots=%23011b1a,%23007872,%2300c4b8,%2389fff7


      # 2) Rotate snake modes (A -> B -> ... -> G -> A)
      - name: Pick next variant (A–G) and update snake.svg
        shell: bash
        run: |
          set -euo pipefail
          MODE_FILE=".github/snake-mode"
          ORDER=(a b c d e f g)
          mkdir -p .github dist

          if [[ -f "$MODE_FILE" ]]; then
            LAST_MODE=$(tr -d '\n\r' < "$MODE_FILE")
          else
            LAST_MODE="g"
          fi

          NEXT_MODE="a"
          for i in "${!ORDER[@]}"; do
            if [[ "${ORDER[$i]}" == "$LAST_MODE" ]]; then
              NEXT_INDEX=$(( (i + 1) % ${#ORDER[@]} ))
              NEXT_MODE="${ORDER[$NEXT_INDEX]}"
              break
            fi
          done

          echo "Last mode: $LAST_MODE"
          echo "Next mode: $NEXT_MODE"

          SRC="dist/snake-${NEXT_MODE}.svg"
          if [[ ! -f "$SRC" ]]; then
            echo "ERROR: Expected file '$SRC' not found."
            ls -la dist || true
            exit 1
          fi

          cp -f "$SRC" dist/snake.svg
          printf '%s\n' "$NEXT_MODE" > "$MODE_FILE"

      # 3) Commit & push updated snake.svg + variants
      - name: Commit and push changes
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add dist/snake-*.svg dist/snake.svg .github/snake-mode || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "chore: update dynamic snake (A–G rotation)"
          git push origin main
