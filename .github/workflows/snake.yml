name: Generate Snake

on:
  schedule:
    # Every 5 minutes (testing mode)
    - cron: "*/5 * * * *"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: github-snake
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1) Generate all 7 snake variants (A–G)
      # Each variant uses a different palette and snake/dot colors.
      - name: Generate snake variants (A–G)
        uses: Platane/snk/svg-only@v3
        with:
          github_user_name: evgeniimatveev
          outputs: |
            dist/snake-a.svg?palette=github-dark&color_snake=#ff66c4&color_dots=#0e4429,#006d32,#26a641,#39d353
            dist/snake-b.svg?palette=github-dark&color_snake=#5fd1ff&color_dots=#0b1020,#004d75,#0094d4,#4dd2ff
            dist/snake-c.svg?palette=github-dark&color_snake=#ffb86c&color_dots=#22130b,#7c3f00,#ff9f1a,#ffd27f
            dist/snake-d.svg?palette=github-dark&color_snake=#ff79c6&color_dots=#251022,#9b287b,#ff4fa3,#ffc1e3
            dist/snake-e.svg?palette=github-dark&color_snake=#a2ff5e&color_dots=#101a0c,#3f6f22,#71c837,#c9ff9d
            dist/snake-f.svg?palette=github-dark&color_snake=#ffd166&color_dots=#261a00,#8c5e00,#ffba08,#ffe08a
            dist/snake-g.svg?palette=github-dark&color_snake=#64fff2&color_dots=#011b1a,#007872,#00c4b8,#89fff7

      # 2) Rotate snake modes (A -> B -> C -> ... -> G -> back to A)
      # The selected variant is copied to dist/snake.svg
      - name: Pick next variant (A–G) and update snake.svg
        shell: bash
        run: |
          set -e

          MODE_FILE=".github/snake-mode"
          ORDER=(a b c d e f g)

          mkdir -p .github dist

          # Read last used mode or initialize with 'g' (so first run becomes 'a')
          if [[ -f "$MODE_FILE" ]]; then
            LAST_MODE=$(tr -d '\n\r' < "$MODE_FILE")
          else
            LAST_MODE="g"
          fi

          # Find next mode in rotation
          NEXT_MODE="a"
          for i in "${!ORDER[@]}"; do
            if [[ "${ORDER[$i]}" == "$LAST_MODE" ]]; then
              NEXT_INDEX=$(( (i + 1) % ${#ORDER[@]} ))
              NEXT_MODE="${ORDER[$NEXT_INDEX]}"
              break
            fi
          done

          echo "Last mode: $LAST_MODE"
          echo "Next mode: $NEXT_MODE"
          echo "::notice title=Snake Variant::Using variant '$NEXT_MODE'"

          SRC="dist/snake-${NEXT_MODE}.svg"

          # Safety check — make sure the variant actually exists
          if [[ ! -f "$SRC" ]]; then
            echo "ERROR: Expected file '$SRC' not found."
            echo "Listing dist folder:"
            ls -l dist || true
            exit 1
          fi

          # Copy the selected variant as the public snake.svg
          cp -f "$SRC" dist/snake.svg

          # Save next mode for the next workflow run
          printf '%s\n' "$NEXT_MODE" > "$MODE_FILE"

      # 3) Commit & push updated snake.svg + all variant updates
      - name: Commit and push changes
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add dist/snake-*.svg dist/snake.svg .github/snake-mode || true

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "chore: update dynamic snake (A–G rotation)"
          git push origin main
